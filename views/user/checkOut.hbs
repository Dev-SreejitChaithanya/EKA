
<body class="page-template belle">
    <div class="pageWrapper">


        <!--Body Content-->
        <div id="page-content">
            <!--Page Title-->
            <div class="page section-header text-center">
                <div class="page-title">
                    <div class="wrapper"></div>
                </div>
            </div>
            <!--End Page Title-->

            <div class="container">

<br>
                <div class="row billing-fields">
                    <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 sm-margin-30px-bottom">
                        <div class="create-ac-content bg-light-gray padding-20px-all">
                            <form class="row g-3">
                                <h2 class="login-title mb-3">Billing details</h2>
                                {{!-- <div class="col-md-6">
                                    <label for="inputEmail4" class="form-label">First Name</label>
                                    <input type="email" class="form-control" id="inputEmail4">
                                </div>
                                <div class="col-md-6">
                                    <label for="inputPassword4" class="form-label">Last Name</label>
                                    <input type="password" class="form-control" id="inputPassword4">
                                </div>
                                <div class="col-12">
                                    <label for="inputAddress" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="inputAddress"
                                        placeholder="1234 Main St">
                                </div>
                                <div class="col-md-6">
                                    <label for="inputCity" class="form-label">City</label>
                                    <input type="text" class="form-control" id="inputCity">
                                </div>
                                <div class="col-md-6">
                                    <label for="inputState" class="form-label">State</label>
                                    <input type="text" class="form-control" id="inputCity">
                                </div>
                                <div class="col-md-6">
                                    <label for="inputZip" class="form-label">Pincode</label>
                                    <input type="text" class="form-control" id="inputZip">
                                </div> --}}
                                <label class="form-label select-label"><strong>Saved Address</strong></label>
                                <select class="form-control" id="addressForm" onchange="addressValue()">
                                    {{#each userAddress}}
                                    <option value="{{this._id}}">{{this.name}},{{this.add}}</option>

                                    {{/each}}

                                </select>

                                <input type="hidden" name="addressSelect" >
                            </form>
                            <br>
                            <button class="btn  btn-sm mb-2  " onclick="addNewAddress()" <i
                                class="ci-close-circle me-2"></i><span class="fs-sm">Add New Address</span>Â </button>
                        </div>
                    </div>

                    <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                        <div class="your-order-payment">
                            <div class="your-order">
                                <h2 class="order-title mb-4">Your Order</h2>

                                <div class="table-responsive-sm order-table table-bordered">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th scope="col">Product Name</th>
                                                <th scope="col">Qty</th>
                                                <th scope="col">Price</th>

                                            </tr>
                                        </thead>
                                        <tbody>
                                            {{#each productDetails}}
                                            <tr>
                                                <th scope="row">{{this.name}}</th>
                                                <td>{{this.quantity}}</td>
                                                <td>{{this.price}}</td>
                                                <input type="hidden" name="productid" value="{{this._id}}">
                                                <input type="hidden" name="productname" value="{{this.name}}">
                                                <input type="hidden" name="price" value="{{this.price}}">
                                                <input type="hidden" name="quantity" value="{{this.quantity}}">
                                            </tr>
                                            {{/each}}
                                        </tbody>
                                        <tfoot>
                                                                                        <tr>
                                                <td>Tax</td>
                                                <td></td>
                                                <td>{{tax}}</td>
                                            </tr>
                                                                                                                                    <tr>
                                                <td>Offer</td>
                                                <td></td>
                                                
                                                <td><span id="offer">{{offer}}</span></td>
                                            </tr>
                                            <tr>
                                                <td>Total</td>
                                                <td></td>
                                                <td><span id="total">{{subtotal}}</span></td>
                                                
                                            </tr>

                                        </tfoot>
                                    </table>

                                </div>
                            </div>
                            <br>
                            <hr>
                <div class="card mb-4">
                    <div class="card-header py-3">
                        <h5 class="mb-0">Apply Promo Code</h5>
                    </div>
                    <div class="card-body">
                         
                        <ul class="list-group list-group-flush">
                            
                            <li
                                class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                                Code
                                <input type="text" id="couponCode">
                                                        <button  class="btn btn-dark btn-lg btn-block " onclick="checkCoupon()" id="couponButton">
                            Apply Code
                        </button>
                                <br>
                            </li>
                            <br>
                        </ul>

                        <span id="errorMessage"></span>
                    
                    </div>
                </div>
                            <div class="your-payment">
                                <h2 class="payment-title mb-3">Payment Method</h2>
                                <br>
                                <div class="payment-method">
                                    <div class="form-check" onclick="displayRadioValue()">
                                        <input class="form-check-input" type="radio" name="payment" id="COD" value="1" >
                                        <label class="form-check-label" for="payment1">
                                            Cash On Delivery
                                        </label>
<div>
                                            <input class="form-check-input" type="radio" name="payment" id="RAZORPAY"
                                            value="2">
                                        <label class="form-check-label" for="payment2">
                                            RazorPay
                                        </label>
                                        
</div>
                                    </div>


                                    <hr>


                                    <div class="order-button-payment">
                                        <button class="btn" onclick="placeOrder()" value="Place order" id="placeOrderButton"
                                            type="submit" hidden>Place order</button>
                                             <button class="btn"  value="Place order" id="rzp-button1"
                                            type="submit" hidden >Place order</button>
                                    </div>
                                    <input type="hidden" name="radioValue">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!--End Body Content-->


        <!-- Modal -->
        <div class="modal fade" id="addAddressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
            aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">Add New Address</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form class="row g-3" method="post">

                            <div class="row g-2">
                                <div class="col-6">
                                    <br>
                                    <label for="inputCity" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="modalName" name="name">

                                </div>

                                <div class="col-6">
                                    <br>
                                    <label for="inputCity" class="form-label">Mobile</label>
                                    <input type="text" class="form-control" id="modalMobile" name="mobile">

                                </div>

                            </div>

                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="inputEmail4" class="form-label">Address</label>
                                    <input type="text" style="height :260px;" class="form-control" id="modalAddress"
                                        name="add">
                                    <br>
                                </div>
                                <div class="col-6">
                                    <label for="inputCity" class="form-label">City</label>
                                    <input type="text" class="form-control" id="modalCity" name="city">
                                    <br>
                                    <div class="col-12">
                                        <label for="inputCity" class="form-label">State</label>
                                        <input type="text" class="form-control" id="modalState" name="state">
                                    </div>
                                    <br>
                                    <div class="col-12">
                                        <label for="inputCity" class="form-label">Pincode</label>
                                        <input type="number" class="form-control" id="modalPin" name="pin">
                                        <br>
                                    </div>
                                </div>
                            </div>
                    </div>
                    <div class="row sign-btn2">
                        <div class="col-sm-1 m-2">

                            <button type="button" class="btn btn-secondary" onclick="insertAddress()">Add</button>
                            <br><br>
                        </div>
                        <div class="col-sm-1 m-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>

                    </div>

                    </form>
                </div>

            </div>
        </div>
    </div>
    </div>
    {{!-- <input type="hidden" id="subT" value="{{multiplyThings subtotal 100}}"> --}}
    <input type="hidden" id="subT" value="{{multiplyThings subtotal 100}}">
</body>
<script>
    var razorpayAmount;
    function addressValue() {
        var selObj = document.getElementById("addressForm");
        var selValue = selObj.options[selObj.selectedIndex].value;
        document.getElementsByName('addressSelect').value = selValue
        
    }

    function displayRadioValue() {
        var ele = document.getElementsByName('payment');

        for (i = 0; i < ele.length; i++) {
            if (ele[i].checked)
               { document.getElementsByName("radioValue").value = String(ele[i].value);
               if(document.getElementsByName("radioValue").value==1)
                {document.getElementById("placeOrderButton").hidden=false;
                document.getElementById("rzp-button1").hidden=true;}
                else
               {document.getElementById("rzp-button1").hidden=false;
                document.getElementById("placeOrderButton").hidden=true;}
                }

        }
    }


    async function placeOrder() {
        const productid = Object.values(document.getElementsByName('productid')).map((item) => item.value)
        const productname = Object.values(document.getElementsByName('productname')).map((item) => item.value)
        const price = Object.values(document.getElementsByName('price')).map((item) => item.value)
        const quantity = Object.values(document.getElementsByName('quantity')).map((item) => item.value)
        const addressId = document.getElementsByName('addressSelect').value
        //const finalamt=Number(document.getElementById('total').innerHTML)
      



        const payment = document.getElementsByName("radioValue").value
        let data = {
            productid: productid,
            productname: productname,
            price: price,
            quantity: quantity,
            addressId: addressId,
            payment: payment,
            total:razorpayAmount
        }
        try {
            const orderplacement = await fetch('/placeOrder', {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            let res = await orderplacement.json()
            if (res == "success") {
                

                Swal.fire({
                    title: 'Success',
                    text: "Item ordered successfully !",
                    icon: 'success',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'OK',
                    timer: 3000
                }).then((res) => {
                    
                    window.location.href = '/home'
                })
            } else Swal.fire({
                title: 'Something went wrong',
                text: "something went wrong !",

                icon: 'failure',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'OK',
                timer: 3000
            }).then((res) => {
                window.location.href = '/home'
            })
        } catch (error) {
            console.log(error)
        }

    }
    
    async function addNewAddress() {
        $('#addAddressModal').modal('show')
    }

    async function checkCoupon()
    {
        console.log("180 check >>")
        const coupon=document.getElementById('couponCode').value;
        console.log(coupon)
        let valCoupon = await fetch('/validateCoupon', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json'},
            body: JSON.stringify({code:coupon}),  
        });
        let response=await valCoupon.json()
       
        if(response=="fail")
        {
            document.getElementById("errorMessage").innerHTML="Coupon Invalid";
            document.getElementById("offer").innerHTML=0
            
            
        }
        else
        {
            document.getElementById("errorMessage").innerHTML="Coupon Applied";
            document.getElementById("offer").innerHTML=Number(document.getElementById("total").innerHTML)*Number(response)/100;

            document.getElementById("total").innerHTML=Number(document.getElementById("total").innerHTML)-Number(document.getElementById("offer").innerHTML)
            document.getElementById("couponButton").disabled=true;
            alert(document.getElementById("total").innerHTML)
            razorpayAmount=document.getElementById("total").innerHTML
            alert(razorpayAmount)
            console.log(Number(response)/100)
        }
    }



    async function insertAddress() {
        const name = document.getElementById('modalName').value
        const mobile = document.getElementById('modalMobile').value
        const address = document.getElementById('modalAddress').value
        const city = document.getElementById('modalCity').value
        const state = document.getElementById('modalState').value
        const pincode = document.getElementById('modalPin').value

        let addAddress = await fetch('/addAddress', {
            headers: {
                'Content-Type': 'application/json',
            },
            method: 'post',
            body: JSON.stringify({ name: name, mobile: mobile, add: address, city: city, state: state, pin: pincode, cart: true }),
        })
        
        let response = await addAddress.json()
        if (response == 'success') {
            $('#addAddressModal').modal('hide')
            Swal.fire({
                title: 'Success',
                text: "Address Added Successfully !",
                icon: 'success',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'OK',
                timer: 3000
            }).then((res) => {
                window.location.reload()
            })
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong!',
            })
        }
    }


//Razorpay 

 var orderId,subT;
  $(document).ready(function () {
    razorpayAmount= Number(document.getElementById('total').innerHTML);
   /* var settings = {
      url: "/create/orderId",
      method: "POST",
      timeout: 0,
      headers: {
        "Content-Type": "application/json",
      },
      data: JSON.stringify({
        //amount: (Number(document.getElementById("subT").value)-Number(document.getElementById("offer").innerHTML))//CHANGE THE AMOUNT AS NEEDED
        amount: 12*100
      }),
    };

    //creates new orderId everytime
    $.ajax(settings).done(function (response) {
      orderId = response.orderId;
      console.log(orderId);
    });*/
  });



  document.getElementById("rzp-button1").onclick = function (e) {
        var settings = {
      url: "/create/orderId",
      method: "POST",
      timeout: 0,
      headers: {
        "Content-Type": "application/json",
      },
      data: JSON.stringify({
        //amount: (Number(document.getElementById("subT").value)-Number(document.getElementById("offer").innerHTML))//CHANGE THE AMOUNT AS NEEDED
        amount: razorpayAmount*100
      }),
    };

    //creates new orderId everytime
    $.ajax(settings).done(function (response) {
      orderId = response.orderId;
      console.log(orderId);
    });
   
    var options = {
      key: "rzp_test_ASawQP7nVsBtie", // Enter the Key ID generated from the Dashboard
      amount: razorpayAmount*100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      currency: "INR",
      name: "EKA",
      description: "Test Transaction",
      image: "https://example.com/your_logo",
      order_id: orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      handler: function (response) {
       /* alert(response.razorpay_payment_id);
        alert(response.razorpay_order_id);
        alert(response.razorpay_signature);*/
        var settings = {
          url: "/api/payment/verify",
          method: "POST",
          timeout: 0,
          headers: {
            "Content-Type": "application/json",
          },
          data: JSON.stringify({ response }),
        };
console.log(response)
        $.ajax(settings).done(function (response) {
           placeOrder();
          //alert(JSON.stringify(response));
        });
      },

      theme: {
        color: "#99cc33",
      },
    };
    var rzp1 = new Razorpay(options);
    rzp1.on("payment.failed", function (response) {
      alert(response.error.code);
      alert(response.error.description);
      alert(response.error.source);
      alert(response.error.step);
      alert(response.error.reason);
      alert(response.error.metadata.order_id);
      alert(response.error.metadata.payment_id);
    });
    rzp1.open();
    e.preventDefault();
  };


</script>